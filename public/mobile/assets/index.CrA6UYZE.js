import{a0 as e,d as a,r as t,aM as l,B as i,av as s,E as r,c as o,o as u,i as c,w as n,g as v,H as d,a as p,W as f,b as h,X as y,aD as b,h as g,V as m,f as k,t as S,N as x,aN as z,aO as w,bu as _,_ as T,bq as C,F as O,j as I,K as j,bv as $,Q as E}from"./index-DE5OqlOG.js";import{b as M,e as N}from"./tig-layout.fowSnIDi.js";const D=T(a({__name:"VerifySlide",props:{captchaType:{type:String,default:"blockPuzzle"},imgSize:{type:Object,default:()=>({width:"310px",height:"155px"})},explain:{type:String,default:"向右拖动滑块填充拼图"},blockSize:{type:Object,default:()=>({width:50,height:50})},barSize:{type:Object,default:()=>({width:"310px",height:"40px"})},barMarginTop:{type:Number,default:8}},emits:["close","success"],setup(a,{expose:T,emit:C}){const O=a,I=C,j=t(!1),$=t(""),E=t(""),M=t(""),N=t(""),D=t(""),A=t(0),q=async()=>{try{const t=await(a={captchaType:O.captchaType},e({url:"common/verification/captcha",method:"POST",data:a}));$.value=t.originalImageBase64,E.value=t.jigsawImageBase64,M.value=t.token,N.value=t.secretKey}catch(t){console.error(t),D.value=t.message}var a},B=t(!1),F=t(""),J=t(""),P=t(""),V=t(""),X=t("#ddd"),Z=t("#d1e0f1"),K=t(""),R=t("icon-right"),G=t(!1),H=t(!1),Q=t(""),U=t(""),W=t(0),L=t(""),Y=t({left:0,top:0,width:0,height:0}),ee=t(0),ae=w(),te={active:{block:"#1991fa",border:"#1991fa",background:"#d1e0f1",icon:"#fff"},success:{block:"#52ccba",border:"#52ccba",background:"#d2f4ef",icon:"#fff"},error:{block:"#d9534f",border:"#d9534f",background:"#fce1e1",icon:"#fff"},default:{block:"#fff",border:"#ddd",background:"#d1e0f1",icon:"#666"}},le=e=>{const a=te[e];V.value=a.block,X.value=a.border,Z.value=a.background,K.value=a.icon},ie=e=>{try{if(H.value)return;const a=e.touches[0].clientX;W.value=Math.floor(a-Y.value.left),A.value=Date.now(),L.value="",le("active"),G.value=!0}catch(a){console.error("滑块验证初始化错误:",a)}},se=e=>{var a,t;try{if(!G.value||H.value)return;const l=e.touches[0].clientX,i=(null==(a=Y.value)?void 0:a.left)||0,s=parseInt(O.blockSize.width)/2,r=((null==(t=Y.value)?void 0:t.width)||0)-s-2;let o=l-i;o=Math.max(s,Math.min(o,r));const u=o-W.value;J.value=`${u}px`,P.value=`${u+40}px`}catch(l){console.error("滑块移动处理错误:",l)}},re=e=>{try{if(ee.value=Date.now(),!G.value||H.value)return;const e=oe();ce(e)}catch(a){console.error("滑块验证结束处理错误:",a),ve()}},oe=()=>310*parseInt((J.value||"0").replace("px",""))/(parseInt(O.imgSize.width)||310),ue=e=>{const a={x:e,y:5};return N.value?_(JSON.stringify(a),N.value):JSON.stringify(a)},ce=async a=>{try{const t={captchaType:O.captchaType,pointJson:ue(a),token:M.value},l=await(a=>e({url:"common/verification/check",method:"POST",data:a}))(t);if(console.log("验证结果:",l),l.token){le("success"),R.value="icon-check",B.value=!1,H.value=!0,j.value=!0;const e=((ee.value-A.value)/1e3).toFixed(2);D.value=`${e}s验证成功`;const t={x:a,y:5},l=JSON.stringify(t),i=N.value?_(M.value+"---"+l,N.value):M.value+"---"+l;setTimeout(()=>{D.value="",I("close"),I("success",{verifyToken:i})},1e3)}else ne()}catch(t){console.error(t),ne()}finally{G.value=!1}},ne=()=>{le("error"),R.value="icon-close",j.value=!1,setTimeout(()=>ve(),1e3),D.value="验证失败",setTimeout(()=>{D.value=""},1e3)},ve=()=>{B.value=!0,F.value="",Q.value="left .3s",J.value="",P.value="",U.value="width .3s",le("default"),R.value="icon-right",H.value=!1,q(),setTimeout(()=>{U.value="",Q.value="",L.value=O.explain},300)};return l(()=>{q(),setTimeout(()=>{(async()=>{try{const e=await z(".verify-bar-area",ae);e&&(Y.value=e)}catch(e){console.error(e)}})()},350)}),T({refresh:ve}),(e,t)=>{const l=h,z=c,w=g,_=i(r("up-transition"),s);return u(),o(z,{class:"verifyslide"},{default:n(()=>[v(z,{class:"verify-img-out",style:d({height:parseInt(a.imgSize.height)+"px"})},{default:n(()=>[v(z,{class:"verify-img-panel",style:d({width:a.imgSize.width,height:a.imgSize.height})},{default:n(()=>[$.value?(u(),o(l,{key:0,src:"data:image/png;base64,"+$.value,class:"img"},null,8,["src"])):p("",!0),$.value?f((u(),o(z,{key:1,class:"verify-refresh",onClick:ve},{default:n(()=>[b("i",{class:"iconfont-pc icon-refresh"})]),_:1},512)),[[y,B.value]]):p("",!0),v(_,{show:!!D.value,mode:"fade-up"},{default:n(()=>[v(w,{class:m("verify-tips "+(j.value?"suc-bg":"err-bg"))},{default:n(()=>[k(S(D.value),1)]),_:1},8,["class"])]),_:1},8,["show"])]),_:1},8,["style"])]),_:1},8,["style"]),v(z,{class:"verify-bar-area",style:d({width:a.imgSize.width,height:a.barSize.height,"line-height":a.barSize.height,marginTop:a.barMarginTop+"px"})},{default:n(()=>[v(w,{class:"verify-msg"},{default:n(()=>[k(S(L.value),1)]),_:1}),v(z,{class:"verify-left-bar",style:d({width:void 0!==P.value?P.value:a.barSize.height,height:a.barSize.height,"border-color":X.value,"background-color":Z.value,transition:U.value})},{default:n(()=>[v(w,{class:"verify-msg",textContent:S(F.value)},null,8,["textContent"]),v(z,{class:"verify-move-block",style:d({width:a.barSize.height,height:a.barSize.height,"background-color":V.value,left:J.value,transition:Q.value}),onTouchstart:ie,onTouchmove:x(se,["stop","prevent"]),onTouchend:re},{default:n(()=>[b("i",{class:m(["verify-icon iconfont-pc",R.value]),style:d({color:K.value})},null,6),v(z,{class:"verify-sub-block",style:d({width:Math.floor(47*parseInt(a.imgSize.width)/310)+"px",height:a.imgSize.height,top:"-"+(parseInt(a.imgSize.height)+a.barMarginTop)+"px","background-size":a.imgSize.width+" "+a.imgSize.height})},{default:n(()=>[E.value?(u(),o(l,{key:0,src:"data:image/png;base64,"+E.value,class:"img"},null,8,["src"])):p("",!0)]),_:1},8,["style"])]),_:1},8,["style"])]),_:1},8,["style"])]),_:1},8,["style"])]),_:1})}}}),[["__scopeId","data-v-85944f77"]]),A=T(a({__name:"Verify",props:{captchaType:{type:String,required:!0},figure:{type:Number},arith:{type:Number},mode:{type:String,default:"pop"},vSpace:{type:Number},explain:{type:String},imgSize:{type:Object,default:()=>({width:"310px",height:"155px"})},blockSize:{type:Object},barSize:{type:Object},close:{type:Function}},emits:["okCallback"],setup(e,{expose:a,emit:l}){const s=e,{captchaType:d,figure:f,arith:h,mode:y,vSpace:b,explain:g,imgSize:m,blockSize:x,barSize:z}=C(s),w=t({}),_=l,T=t(!1),I=()=>{T.value=!1,w.value.refresh&&w.value.refresh()},j=e=>{_("okCallback",e)};return a({show:()=>{T.value=!0}}),(e,a)=>{const t=c,l=i(r("tig-popup"),M);return u(),o(l,{show:T.value,"onUpdate:show":a[0]||(a[0]=e=>T.value=e),"mask-click":!1,"custom-style":{width:O(m).width,"box-sizing":"content-box",padding:"10rpx 30rpx"},position:"center"},{default:n(()=>[v(t,{class:"content"},{default:n(()=>[v(t,{class:"title"},{default:n(()=>[k(S(e.$t("请完成安全验证")),1)]),_:1}),T.value?(u(),o(D,{key:0,ref_key:"instance",ref:w,"captcha-type":O(d),type:"2",figure:O(f),arith:O(h),mode:O(y),"v-space":O(b),explain:O(g),"img-size":O(m),"block-size":O(x),"bar-size":O(z),onClose:I,onSuccess:j},null,8,["captcha-type","figure","arith","mode","v-space","explain","img-size","block-size","bar-size"])):p("",!0)]),_:1})]),_:1},8,["show","custom-style"])}}}),[["__scopeId","data-v-fc76f1fe"]]),q=T(a({__name:"index",props:{email:{type:String,default:""},mobile:{type:String,default:""},requestApi:{type:Function,required:!0},isChecked:{type:Boolean,default:!1},verifyTokenData:{type:String,default:null},event:{type:String,default:"login"},btnType:{type:String,default:"button"}},emits:["mobileErrorCallback","update:isChecked","update:verifyTokenData"],setup(e,{emit:a}){const l=I(),{t:s}=j(),d=e,f=a,{mobile:h}=C(d),y=t(),b=t(""),g=t(!1),m=t(null),x=t(),z=()=>{g.value=!1},w=()=>{g.value=!0},_=async()=>{if(!1===d.isChecked)return f("mobileErrorCallback",s("请阅读并同意协议！"));if(!g.value){if(d.email){if(""==d.email)return void f("mobileErrorCallback",s("邮箱不能为空！"));if(!D(d.email))return void f("mobileErrorCallback",s("邮箱格式错误"))}else{if(""==h.value)return void f("mobileErrorCallback",s("手机号不能为空！"));if(!M(h.value))return void f("mobileErrorCallback",s("手机号格式错误"))}m.value?T():x.value.show()}},T=async()=>{try{await d.requestApi({mobile:h.value,email:d.email,verifyToken:m.value,event:d.event}),f("update:verifyTokenData",m.value),E({title:s("验证码已发送"),duration:1500}),y.value.canGetCode&&y.value.start()}catch(e){f("mobileErrorCallback",e.message),f("update:verifyTokenData","")}finally{m.value=null}},O=e=>{b.value=e},M=e=>!!(l.isOpenMobileAreaCode?/^[1-9]\d{10,14}$/:/^(?:(?:\+|00)86)?1\d{10}$/).test(e),D=e=>/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(e),q=e=>{m.value=e.verifyToken,_()};return(a,t)=>{const l=i(r("tig-button"),N),s=c,d=i(r("up-code"),$);return u(),o(s,{class:"box"},{default:n(()=>["button"===e.btnType?(u(),o(l,{key:0,plain:!0,disabled:g.value,class:"btn-verify",onClick:_},{default:n(()=>[k(S(b.value),1)]),_:1},8,["disabled"])):p("",!0),"text"===e.btnType?(u(),o(s,{key:1,plain:!0,disabled:g.value,class:"verify-btn",onClick:_},{default:n(()=>[k(S(b.value),1)]),_:1},8,["disabled"])):p("",!0),v(d,{ref_key:"uCodeRef",ref:y,seconds:60,"start-text":a.$t("获取验证码"),"end-text":a.$t("重新获取"),"change-text":a.$t("X秒重新获取"),onEnd:z,onStart:w,onChange:O},null,8,["start-text","end-text","change-text"]),v(A,{ref_key:"verifyRef",ref:x,mode:"pop","captcha-type":"blockPuzzle","img-size":{width:"310px",height:"155px"},onOkCallback:q},null,512)]),_:1})}}}),[["__scopeId","data-v-480a38d5"]]);export{q as V,A as a};
