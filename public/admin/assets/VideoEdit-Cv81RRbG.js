import"./index-BdoKLCH8.js";import{i as H}from"./format-CpNC4fsQ.js";import{F as P}from"./UploadAvatar.vue_vue_type_style_index_0_scoped_3ec2e0ca_lang-CloSefEz.js";import"./vuedraggable.umd-CLczY9wy.js";import{d as Q,r as u,v as X,Y as Z,o as ee,J as i,e as c,f as g,g as b,h as s,y as r,l as n,i as a,dJ as te,dK as V,ds as oe,t as ae,K as S,_ as le}from"./index-BGgofOm4.js";import{n as re,o as se,p as ie}from"./gallery-jVLe5Rxg.js";import{a as ne}from"./time-BL_Iz6xX.js";import{u as de}from"./gallery-CXZTGefd.js";import{_ as ue}from"./DialogForm.vue_vue_type_script_setup_true_lang-BTf40oxg.js";import"./index-BS7Hjr9I.js";import"./Image.vue_vue_type_script_setup_true_lang-oDjiJjwB.js";import"./BusinessImg-Dt_2PeVb.js";const pe={class:"container"},ce={class:"content_wrapper"},me={class:"lyecs-form-table"},fe={key:0,class:"video-preview"},ve=["src"],ye={key:1,style:{width:"400px"}},_e={class:"gallery-add-item flex flex-justify-center flex-align-center"},ge={class:"extra mt10"},be={class:"flex flex-justify-between"},xe={class:"con-btn ml10 flex flex-align-center flex-justify-center"},he=Q({__name:"VideoEdit",props:{id:{type:Number,default:0},parentId:{type:Number,default:0},act:{type:String,default:""},galleryId:{type:Number,default:0},isDialog:Boolean},emits:["submitCallback","okType","callback"],setup(N,{expose:L,emit:R}){const z=u(),x=X();x.updateConfig();const v=x.config.uploadMaxSize,m=u([]),f=u(!0),j={label:"name",value:"id",children:"children",checkStrictly:!0,multiple:!1},E={strokeWidth:5,format:e=>`${parseFloat((e??"0").toString())}%`},h=N,{id:U,act:I}=Z(h),T=I.value=="add"?"create":"update",B=(e,t,l)=>{if(t)if(t.length>20){l(new Error("视频名称不能超过20个字"));return}else l();else{l(new Error("视频名称不能为空"));return}},F=R,k=u();let o=u({galleryId:h.galleryId,videoUrl:"",videoName:"",videoCover:"",format:"",duration:"",size:""});ee(()=>{I.value==="detail"&&$(),_()});const M=de(),w=u([]),y=u(!1),_=async e=>{y.value=!0;try{const t=await re();w.value=t,M.isRefresh=!0}catch(t){i.error(t.message)}finally{setTimeout(()=>{y.value=!1},200)}},$=async()=>{try{const e=await se({id:U.value});o.value=e}catch(e){i.error(e.message)}},G={".mp4":"video/mp4"},O=e=>{f.value=!0;const t="."+e.name.split(".").pop().toLowerCase();if(!Object.keys(G).includes(t))return i.error(`不支持 ${t} 格式的视频文件`),!1;const l=e.size/1024/1024<Number(v);return l||i.error(`只能上传${v}M以内的视频`),q(e),l},q=e=>{const t=URL.createObjectURL(e),l=document.createElement("video");l.src=t,l.onloadedmetadata=()=>{const p=l.duration;o.value.duration=ne(p),l.currentTime=.1},l.onerror=()=>{i.error("视频文件损坏或无法读取"),URL.revokeObjectURL(t)}},A=e=>{e.file.status||(f.value=!1,m.value=[]),e.file.status=="uploading",e.file.status,e.file.status==="done"?e.file.response.code!==0?(e.file.status="error",i.error(e.file.response.message)):(m.value=[e.file],o.value.size=e.file&&e.file.size?`${(e.file.size/1024/1024).toFixed(2)}MB`:"",Object.assign(o.value,e.file.response.data),i.success("视频上传成功！"),f.value=!1):e.file.status==="error"&&i.error(`${e.file.name} 视频上传失败！`)},D=()=>{o.value.videoUrl="",o.value.videoName="",o.value.duration="",m.value=[],f.value=!0},J=async()=>{await k.value.validate(),Array.isArray(o.value.galleryId)||(o.value.galleryId=[o.value.galleryId]);try{const e=await ie(T,{id:U.value,...o.value});F("submitCallback",e),i.success("操作成功")}catch(e){i.error(e.message)}};return L({onFormSubmit:()=>{J()}}),(e,t)=>{const l=c("el-icon"),p=c("el-form-item"),K=c("TigInput"),W=c("el-cascader"),C=c("el-button"),Y=c("el-form");return b(),g("div",pe,[s("div",ce,[s("div",me,[r(Y,{ref_key:"formRef",ref:k,model:a(o),"label-width":"auto"},{default:n(()=>[r(p,{prop:"videoUrl",label:"本地视频",rules:[{required:!0,message:"请上传本地视频!"}]},{default:n(()=>[s("div",null,[a(o).videoUrl?(b(),g("div",fe,[s("div",{class:"iconfont icon-cha1 btn-remove",onClick:D}),s("video",{src:a(H)(a(o).videoUrl),controls:"",class:"preview-video"},null,8,ve)])):(b(),g("div",ye,[r(a(te),{name:"file",ref_key:"uploadRef",ref:z,"file-list":m.value,"onUpdate:fileList":t[0]||(t[0]=d=>m.value=d),action:a(V).prefix+"/setting/galleryVideoInfo/uploadVideo",headers:a(V).headers(),showUploadList:f.value,onChange:A,"before-upload":O,progress:E,accept:".mp4,video/*"},{default:n(()=>[s("div",_e,[r(l,{size:"25"},{default:n(()=>[r(a(oe))]),_:1})])]),_:1},8,["file-list","action","headers","showUploadList"])])),s("div",ge,"视频大小不超过"+ae(a(v))+"MB，时长5秒-5分钟以内，建议时长15-190秒， 支持的视频文件类型 .mp4。",1)])]),_:1}),r(p,{prop:"videoName",label:"视频名称",rules:[{required:!0,validator:B}]},{default:n(()=>[r(K,{classType:"tig-form-input",modelValue:a(o).videoName,"onUpdate:modelValue":t[1]||(t[1]=d=>a(o).videoName=d),placeholder:"20个字以内",maxlength:20},null,8,["modelValue"])]),_:1},8,["rules"]),r(p,{prop:"galleryId",label:"所在视频相册",rules:[{required:!0,message:"视频相册不能为空!"}]},{default:n(()=>[s("div",be,[r(W,{modelValue:a(o).galleryId,"onUpdate:modelValue":t[2]||(t[2]=d=>a(o).galleryId=d),options:w.value,props:j,clearable:""},null,8,["modelValue","options"]),s("div",xe,[r(a(ue),{params:{act:"add",parentId:0},path:"gallery/video/GalleryVideoEdit",title:"添加视频相册",width:"400px",onOkCallback:_},{default:n(()=>[r(C,{link:"",type:"primary"},{default:n(()=>t[5]||(t[5]=[S("添加相册",-1)])),_:1,__:[5]})]),_:1}),t[7]||(t[7]=s("p",{class:"ml10 mr10",style:{"margin-bottom":"3px"}},"|",-1)),r(C,{link:"",type:"primary",loading:y.value,onClick:t[3]||(t[3]=d=>_(0))},{default:n(()=>t[6]||(t[6]=[S("刷新",-1)])),_:1,__:[6]},8,["loading"])])])]),_:1}),r(p,{prop:"videoCover",label:"视频封面"},{default:n(()=>[r(a(P),{photo:a(o).videoCover,"onUpdate:photo":t[4]||(t[4]=d=>a(o).videoCover=d)},null,8,["photo"]),t[8]||(t[8]=s("div",{class:"extra"}," 建议尺寸：800*800px，支持.jpg，.gif，.png格式，大小不超过10MB。如果不添加封面， 系统会默认截取视频的第一个画面作为封面。 ",-1))]),_:1,__:[8]})]),_:1},8,["model"])])])])}}}),Te=le(he,[["__scopeId","data-v-e523be5a"]]);export{Te as default};
